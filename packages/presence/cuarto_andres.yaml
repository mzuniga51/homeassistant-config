# =============================================================================
# CUARTO ANDRES - PRESENCE-BASED AUTOMATION PACKAGE
# =============================================================================
# Features:
#   - Bayesian presence detection combining BLE and motion
#   - Light automation with lux threshold, time window, and manual override
#   - AC auto-off when room empty OR door open >5 min (with nighttime protection)
#   - AC temperature regulation using AC sensor feedback loop
#   - AC does NOT auto-resume if door is open
# =============================================================================

# -----------------------------------------------------------------------------
# INPUT TEXT - Entity selectors (for entity picker cards)
# -----------------------------------------------------------------------------
input_text:
  cuarto_andres_tv_entity:
    name: "Cuarto Andres - TV Entity"
    initial: "none"
    icon: mdi:television

  cuarto_andres_temp_sensor_entity:
    name: "Cuarto Andres - Temperature Sensor Entity"
    initial: "none"
    icon: mdi:thermometer

# -----------------------------------------------------------------------------
# INPUT HELPERS - Configurable parameters via UI
# -----------------------------------------------------------------------------
input_boolean:
  # Master switches for automations
  cuarto_andres_light_automation_enabled:
    name: "Cuarto Andres - Light Automation Enabled"
    icon: mdi:lightbulb-auto
    initial: true

  cuarto_andres_ac_automation_enabled:
    name: "Cuarto Andres - AC Automation Enabled"
    icon: mdi:air-conditioner
    initial: true

  # Internal state: tracks if lights were manually cancelled
  cuarto_andres_light_program_cancelled:
    name: "Cuarto Andres - Light Program Cancelled"
    icon: mdi:cancel
    initial: false

  # AC regulation enabled
  cuarto_andres_ac_regulation_enabled:
    name: "Cuarto Andres - AC Temperature Regulation Enabled"
    icon: mdi:thermostat-auto
    initial: true

  # TV auto-off enabled
  cuarto_andres_tv_automation_enabled:
    name: "Cuarto Andres - TV Auto-Off Enabled"
    icon: mdi:television-off
    initial: true

  # AC manual off tracking (reset at midnight)
  cuarto_andres_ac_manual_off:
    name: "Cuarto Andres - AC Manually Off"
    icon: mdi:hand-back-left-off
    initial: false
  
  # AC turned off due to door open (won't auto-resume until manually turned on)
  cuarto_andres_ac_door_off:
    name: "Cuarto Andres - AC Off Due to Door"
    icon: mdi:door-open
    initial: false

input_number:
  # Light automation parameters
  cuarto_andres_lux_threshold:
    name: "Cuarto Andres - Lux Threshold"
    min: 0
    max: 500
    step: 5
    unit_of_measurement: "lx"
    icon: mdi:brightness-6
    initial: 50

  cuarto_andres_light_off_delay:
    name: "Cuarto Andres - Light Off Delay"
    min: 1
    max: 30
    step: 1
    unit_of_measurement: "min"
    icon: mdi:timer-outline
    initial: 5

  # AC automation parameters
  cuarto_andres_ac_off_delay:
    name: "Cuarto Andres - AC Off Delay"
    min: 1
    max: 60
    step: 1
    unit_of_measurement: "min"
    icon: mdi:timer-outline
    initial: 5

  cuarto_andres_ac_door_off_delay:
    name: "Cuarto Andres - AC Door Open Off Delay"
    min: 1
    max: 30
    step: 1
    unit_of_measurement: "min"
    icon: mdi:door-open
    initial: 5

  cuarto_andres_ac_target_temp:
    name: "Cuarto Andres - Target Temperature"
    min: 16
    max: 28
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer
    initial: 20

  cuarto_andres_ac_min_setpoint:
    name: "Cuarto Andres - AC Minimum Setpoint"
    min: 16
    max: 24
    step: 1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-down
    initial: 18

  cuarto_andres_ac_max_setpoint:
    name: "Cuarto Andres - AC Maximum Setpoint"
    min: 20
    max: 30
    step: 1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-chevron-up
    initial: 26

  cuarto_andres_ac_external_temp_reference:
    name: "Cuarto Andres - Outside Neutral Temp"
    min: 20
    max: 30
    step: 1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-alert
    initial: 23

  cuarto_andres_ac_external_correction_factor:
    name: "Cuarto Andres - External Correction Factor"
    min: 0
    max: 1
    step: 0.1
    icon: mdi:tune
    initial: 0.5

  cuarto_andres_ac_regulation_interval:
    name: "Cuarto Andres - AC Regulation Interval"
    min: 5
    max: 60
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sync-outline
    initial: 15

  cuarto_andres_tv_off_delay:
    name: "Cuarto Andres - TV Off Delay"
    min: 1
    max: 60
    step: 1
    unit_of_measurement: "min"
    icon: mdi:timer-outline
    initial: 10

  cuarto_andres_temp_calibration_offset:
    name: "Cuarto Andres - Temperature Calibration Offset"
    min: -4
    max: 4
    step: 0.5
    unit_of_measurement: "°C"
    icon: mdi:thermometer-plus
    initial: 0

  # Bayesian sensor threshold
  cuarto_andres_presence_threshold:
    name: "Cuarto Andres - Presence Probability Threshold"
    min: 0.3
    max: 0.9
    step: 0.05
    icon: mdi:account-question
    initial: 0.5

input_datetime:
  # Light automation time window
  cuarto_andres_light_start_time:
    name: "Cuarto Andres - Light Program Start"
    has_date: false
    has_time: true
    initial: "12:00:00"
    icon: mdi:weather-sunset-up

  cuarto_andres_light_end_time:
    name: "Cuarto Andres - Light Program End"
    has_date: false
    has_time: true
    initial: "00:00:00"
    icon: mdi:weather-sunset-down

  # AC auto-off time window (outside this = protected)
  cuarto_andres_ac_autooff_start:
    name: "Cuarto Andres - AC Auto-Off Start"
    has_date: false
    has_time: true
    initial: "12:00:00"
    icon: mdi:clock-start

  cuarto_andres_ac_autooff_end:
    name: "Cuarto Andres - AC Auto-Off End"
    has_date: false
    has_time: true
    initial: "23:00:00"
    icon: mdi:clock-end

  cuarto_andres_ac_resume_start:
    name: "Cuarto Andres - AC Auto-Resume Start"
    has_date: false
    has_time: true
    initial: "00:00:00"
    icon: mdi:clock-start

  cuarto_andres_ac_resume_end:
    name: "Cuarto Andres - AC Auto-Resume End"
    has_date: false
    has_time: true
    initial: "12:00:00"
    icon: mdi:clock-end

# -----------------------------------------------------------------------------
# TIMER
# -----------------------------------------------------------------------------
timer:
  cuarto_andres_ac_regulation:
    name: "Cuarto Andres - AC Regulation Timer"
    restore: true

# -----------------------------------------------------------------------------
# TEMPLATE SENSORS
# -----------------------------------------------------------------------------
template:
  - sensor:
      # Lux from motion sensor
      - name: "Cuarto Andres Lux"
        unique_id: cuarto_andres_lux
        unit_of_measurement: "lx"
        state_class: measurement
        device_class: illuminance
        state: >
          {{ states('sensor.sensor_andres_movimiento_illuminance') | float(0) }}

      # Current temperature (AC sensor or external sensor + calibration)
      - name: "Cuarto Andres Current Temperature"
        unique_id: cuarto_andres_current_temperature
        unit_of_measurement: "°C"
        state_class: measurement
        device_class: temperature
        state: >
          {% set external = states('input_text.cuarto_andres_temp_sensor_entity') %}
          {% set offset = states('input_number.cuarto_andres_temp_calibration_offset') | float(0) %}
          {% if external != 'none' and states(external) not in ['unknown', 'unavailable'] %}
            {{ (states(external) | float(20) + offset) | round(1) }}
          {% else %}
            {% set ac_temp = state_attr('climate.aire_andres', 'current_temperature') | float(20) %}
            {{ (ac_temp + offset) | round(1) }}
          {% endif %}

      # AC setpoint calculator - feedback loop with external temp correction
      - name: "Cuarto Andres AC Calculated Setpoint"
        unique_id: cuarto_andres_ac_calculated_setpoint
        unit_of_measurement: "°C"
        state: >
          {% set target = states('input_number.cuarto_andres_ac_target_temp') | float(20) %}
          {% set current = states('sensor.cuarto_andres_current_temperature') | float(20) %}
          {% set external = states('sensor.hp2564bu_pro_v1_9_9_feels_like_temperature') | float(25) %}
          {% set min_sp = states('input_number.cuarto_andres_ac_min_setpoint') | float(18) %}
          {% set max_sp = states('input_number.cuarto_andres_ac_max_setpoint') | float(26) %}
          {% set ext_ref = states('input_number.cuarto_andres_ac_external_temp_reference') | float(25) %}
          {% set ext_factor = states('input_number.cuarto_andres_ac_external_correction_factor') | float(0.5) %}
          
          {# Calculate error: positive = room too hot, negative = room too cold #}
          {% set error = current - target %}
          
          {# Base adjustment: for every degree off, adjust setpoint by 1.5 degrees #}
          {% set base_adjustment = error * 1.5 %}
          
          {# External temp correction #}
          {% set external_diff = external - ext_ref %}
          {% set external_correction = (external_diff / 5) * ext_factor %}
          {% set external_correction = [[external_correction, -2] | max, 2] | min %}
          
          {# Total adjustment #}
          {% set total_adjustment = base_adjustment + external_correction %}
          
          {# New setpoint = target - adjustment #}
          {% set new_setpoint = target - total_adjustment %}
          
          {# Clamp to allowed range #}
          {{ [[new_setpoint, min_sp] | max, max_sp] | min | round(0) }}

  - binary_sensor:
      # Is it within light automation time window?
      - name: "Cuarto Andres Light Program Active"
        unique_id: cuarto_andres_light_program_active
        state: >
          {% set start = states('input_datetime.cuarto_andres_light_start_time') %}
          {% set end = states('input_datetime.cuarto_andres_light_end_time') %}
          {% set now_time = now().strftime('%H:%M:%S') %}
          {% if end < start %}
            {{ now_time >= start or now_time < end }}
          {% else %}
            {{ start <= now_time < end }}
          {% endif %}

      # Is it within AC auto-off time window?
      - name: "Cuarto Andres AC AutoOff Window"
        unique_id: cuarto_andres_ac_autooff_window
        state: >
          {% set start = states('input_datetime.cuarto_andres_ac_autooff_start') %}
          {% set end = states('input_datetime.cuarto_andres_ac_autooff_end') %}
          {% set now_time = now().strftime('%H:%M:%S') %}
          {% if end < start %}
            {{ now_time >= start or now_time < end }}
          {% else %}
            {{ start <= now_time < end }}
          {% endif %}

      # Is it within AC auto-resume time window?
      - name: "Cuarto Andres AC Resume Window"
        unique_id: cuarto_andres_ac_resume_window
        state: >
          {% set start = states('input_datetime.cuarto_andres_ac_resume_start') %}
          {% set end = states('input_datetime.cuarto_andres_ac_resume_end') %}
          {% set now_time = now().strftime('%H:%M:%S') %}
          {% if end < start %}
            {{ now_time >= start or now_time < end }}
          {% else %}
            {{ start <= now_time < end }}
          {% endif %}

      # Is lux below threshold?
      - name: "Cuarto Andres Lux Below Threshold"
        unique_id: cuarto_andres_lux_below_threshold
        state: >
          {{ states('sensor.cuarto_andres_lux') | float(0) < 
             states('input_number.cuarto_andres_lux_threshold') | float(50) }}

      # Combined: Should lights auto-trigger?
      - name: "Cuarto Andres Light Trigger Allowed"
        unique_id: cuarto_andres_light_trigger_allowed
        state: >
          {{ is_state('input_boolean.cuarto_andres_light_automation_enabled', 'on') and
             is_state('binary_sensor.cuarto_andres_light_program_active', 'on') and
             is_state('binary_sensor.cuarto_andres_lux_below_threshold', 'on') and
             is_state('input_boolean.cuarto_andres_light_program_cancelled', 'off') }}

      # Presence from Bayesian (threshold-based)
      - name: "Cuarto Andres Occupied"
        unique_id: cuarto_andres_occupied
        device_class: occupancy
        state: >
          {{ state_attr('binary_sensor.cuarto_andres_presence_probability', 'probability') | float(0) >= 
             states('input_number.cuarto_andres_presence_threshold') | float(0.5) }}

      # Motion detected
      - name: "Cuarto Andres Motion Active"
        unique_id: cuarto_andres_motion_active
        device_class: motion
        state: >
          {{ is_state('binary_sensor.sensor_andres_movimiento_motion', 'on') }}

      # BLE device detected
      - name: "Cuarto Andres BLE Present"
        unique_id: cuarto_andres_ble_present
        device_class: presence
        state: >
          {{ states('sensor.iphone_andres_ble_area') == 'Cuarto Andres' }}

      # AC presence for resume window (BLE OR Motion)
      - name: "Cuarto Andres AC Resume Presence"
        unique_id: cuarto_andres_ac_resume_presence
        device_class: occupancy
        state: >
          {{ is_state('binary_sensor.cuarto_andres_motion_active', 'on') or
             is_state('binary_sensor.cuarto_andres_ble_present', 'on') }}

      # Door is open
      - name: "Cuarto Andres Door Open"
        unique_id: cuarto_andres_door_open
        device_class: door
        state: >
          {{ is_state('binary_sensor.puerta_andres_contact', 'on') }}

# -----------------------------------------------------------------------------
# BAYESIAN PRESENCE SENSOR
# -----------------------------------------------------------------------------
binary_sensor:
  - platform: bayesian
    name: "Cuarto Andres Presence Probability"
    unique_id: cuarto_andres_presence_probability
    probability_threshold: 0.5
    prior: 0.25
    observations:
      # ----- BERMUDA: Andres phone in this room -----
      - platform: template
        value_template: >
          {{ states('sensor.iphone_andres_ble_area') == 'Cuarto Andres' }}
        prob_given_true: 0.95
        prob_given_false: 0.10

      # ----- MOTION: Motion sensor active -----
      - platform: template
        value_template: >
          {{ is_state('binary_sensor.sensor_andres_movimiento_motion', 'on') }}
        prob_given_true: 0.90
        prob_given_false: 0.25

# -----------------------------------------------------------------------------
# AUTOMATIONS
# -----------------------------------------------------------------------------
automation:
  # ===========================================================================
  # LIGHT AUTOMATIONS
  # ===========================================================================

  # Turn lights ON when motion detected (if conditions met)
  - id: cuarto_andres_lights_on_presence
    alias: "Cuarto Andres - Lights On (Motion)"
    description: "Turn on lights when motion detected and conditions are met"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.sensor_andres_movimiento_motion
        to: "on"
    condition:
      - condition: state
        entity_id: binary_sensor.cuarto_andres_light_trigger_allowed
        state: "on"
    action:
      - action: light.turn_on
        target:
          entity_id: light.cuarto_andres

  # Turn lights OFF when no motion for X minutes
  - id: cuarto_andres_lights_off_empty
    alias: "Cuarto Andres - Lights Off (No Motion)"
    description: "Turn off lights when no motion for configured delay"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.cuarto_andres_motion_active
        to: "off"
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_light_automation_enabled
        state: "on"
    action:
      - delay:
          minutes: "{{ states('input_number.cuarto_andres_light_off_delay') | int(5) }}"
      - condition: state
        entity_id: binary_sensor.cuarto_andres_motion_active
        state: "off"
      - action: light.turn_off
        target:
          entity_id:
            - light.cuarto_andres
            - light.closet_andres
            - light.bano_andres

  # Cancel light program when switch button pressed
  - id: cuarto_andres_cancel_light_program
    alias: "Cuarto Andres - Cancel Light Program"
    description: "Cancel auto-light program when switch button is pressed"
    mode: single
    trigger:
      - platform: state
        entity_id: event.switch_andres_cama_button_1
    condition:
      - condition: template
        value_template: "{{ states('light.cuarto_andres') == 'on' }}"
    action:
      - action: light.turn_off
        target:
          entity_id:
            - light.cuarto_andres
            - light.closet_andres
            - light.bano_andres
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.cuarto_andres_light_program_cancelled

  # Reset cancelled state at program start time
  - id: cuarto_andres_reset_light_program
    alias: "Cuarto Andres - Reset Light Program"
    description: "Reset the cancelled flag at program start time"
    mode: single
    trigger:
      - platform: time
        at: input_datetime.cuarto_andres_light_start_time
    action:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.cuarto_andres_light_program_cancelled

  # ===========================================================================
  # AC AUTOMATIONS
  # ===========================================================================

  # Turn AC OFF when room empty (within auto-off window)
  - id: cuarto_andres_ac_off_empty
    alias: "Cuarto Andres - AC Off (No Motion)"
    description: "Turn off AC when no motion for configured delay (daytime only)"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.cuarto_andres_motion_active
        to: "off"
        for:
          minutes: "{{ states('input_number.cuarto_andres_ac_off_delay') | int(5) }}"
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_ac_automation_enabled
        state: "on"
      - condition: state
        entity_id: binary_sensor.cuarto_andres_ac_autooff_window
        state: "on"
      - condition: not
        conditions:
          - condition: state
            entity_id: climate.aire_andres
            state: "off"
    action:
      - action: climate.turn_off
        target:
          entity_id: climate.aire_andres

  # Turn AC OFF when door open for X minutes
  - id: cuarto_andres_ac_off_door_open
    alias: "Cuarto Andres - AC Off (Door Open)"
    description: "Turn off AC when door has been open for configured delay"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.puerta_andres_contact
        to: "on"
        for:
          minutes: "{{ states('input_number.cuarto_andres_ac_door_off_delay') | int(5) }}"
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_ac_automation_enabled
        state: "on"
      - condition: not
        conditions:
          - condition: state
            entity_id: climate.aire_andres
            state: "off"
    action:
      - action: climate.turn_off
        target:
          entity_id: climate.aire_andres
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.cuarto_andres_ac_door_off

  # Clear door_off flag when AC is manually turned on
  - id: cuarto_andres_ac_clear_door_off
    alias: "Cuarto Andres - Clear Door Off Flag"
    description: "Clear door_off flag when AC is manually turned on"
    mode: single
    trigger:
      - platform: state
        entity_id: climate.aire_andres
        from: "off"
    action:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.cuarto_andres_ac_door_off

  # Temperature regulation - adjust setpoint at configurable interval
  - id: cuarto_andres_ac_regulate_temperature
    alias: "Cuarto Andres - AC Temperature Regulation"
    description: "Adjust AC setpoint based on room temperature feedback loop"
    mode: single
    trigger:
      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.cuarto_andres_ac_regulation
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_ac_regulation_enabled
        state: "on"
    action:
      - choose:
          # Room is too cold (>2°C below target) - turn AC off for this cycle
          - conditions:
              - condition: template
                value_template: >
                  {{ (states('input_number.cuarto_andres_ac_target_temp') | float(20) - 
                      states('sensor.cuarto_andres_current_temperature') | float(20)) > 2 }}
              - condition: not
                conditions:
                  - condition: state
                    entity_id: climate.aire_andres
                    state: "off"
            sequence:
              - action: climate.turn_off
                target:
                  entity_id: climate.aire_andres
          # AC is off - only turn back on during resume window if presence detected, door closed, and not manually/door off
          - conditions:
              - condition: state
                entity_id: climate.aire_andres
                state: "off"
              - condition: state
                entity_id: binary_sensor.cuarto_andres_ac_resume_window
                state: "on"
              # Check presence (BLE OR Motion)
              - condition: state
                entity_id: binary_sensor.cuarto_andres_ac_resume_presence
                state: "on"
              # Door must be closed
              - condition: state
                entity_id: binary_sensor.puerta_andres_contact
                state: "off"
              # Not manually turned off
              - condition: state
                entity_id: input_boolean.cuarto_andres_ac_manual_off
                state: "off"
              # Not turned off due to door
              - condition: state
                entity_id: input_boolean.cuarto_andres_ac_door_off
                state: "off"
              # Don't turn back on if room is still too cold
              - condition: template
                value_template: >
                  {{ (states('input_number.cuarto_andres_ac_target_temp') | float(20) - 
                      states('sensor.cuarto_andres_current_temperature') | float(20)) <= 2 }}
            sequence:
              - action: climate.turn_on
                target:
                  entity_id: climate.aire_andres
              - delay:
                  seconds: 5
              - action: climate.set_temperature
                target:
                  entity_id: climate.aire_andres
                data:
                  temperature: "{{ states('sensor.cuarto_andres_ac_calculated_setpoint') | float(20) }}"
          # AC is on and room temp is fine - just adjust temperature
          - conditions:
              - condition: not
                conditions:
                  - condition: state
                    entity_id: climate.aire_andres
                    state: "off"
            sequence:
              - action: climate.set_temperature
                target:
                  entity_id: climate.aire_andres
                data:
                  temperature: "{{ states('sensor.cuarto_andres_ac_calculated_setpoint') | float(20) }}"
      # Restart timer for next cycle
      - action: timer.start
        target:
          entity_id: timer.cuarto_andres_ac_regulation
        data:
          duration:
            minutes: "{{ states('input_number.cuarto_andres_ac_regulation_interval') | int(15) }}"

  # Start regulation timer when regulation is enabled
  - id: cuarto_andres_ac_start_regulation_timer
    alias: "Cuarto Andres - Start AC Regulation Timer"
    description: "Start the regulation timer when enabled"
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.cuarto_andres_ac_regulation_enabled
        to: "on"
      - platform: homeassistant
        event: start
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_ac_regulation_enabled
        state: "on"
    action:
      - action: timer.start
        target:
          entity_id: timer.cuarto_andres_ac_regulation
        data:
          duration:
            minutes: "{{ states('input_number.cuarto_andres_ac_regulation_interval') | int(15) }}"

  # Stop timer when regulation is disabled
  - id: cuarto_andres_ac_stop_regulation_timer
    alias: "Cuarto Andres - Stop AC Regulation Timer"
    description: "Stop the regulation timer when disabled"
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.cuarto_andres_ac_regulation_enabled
        to: "off"
    action:
      - action: timer.cancel
        target:
          entity_id: timer.cuarto_andres_ac_regulation

  # Also regulate when AC is turned on
  - id: cuarto_andres_ac_regulate_on_start
    alias: "Cuarto Andres - AC Regulate On Start"
    description: "Set optimal temperature when AC is turned on"
    mode: single
    trigger:
      - platform: state
        entity_id: climate.aire_andres
        from: "off"
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_ac_regulation_enabled
        state: "on"
      # Door must be closed
      - condition: state
        entity_id: binary_sensor.puerta_andres_contact
        state: "off"
    action:
      - delay:
          seconds: 5
      - action: climate.set_temperature
        target:
          entity_id: climate.aire_andres
        data:
          temperature: "{{ states('sensor.cuarto_andres_ac_calculated_setpoint') | float(20) }}"

  # Prevent AC from turning on while door is open
  - id: cuarto_andres_ac_prevent_on_door_open
    alias: "Cuarto Andres - AC Prevent On (Door Open)"
    description: "Turn AC back off immediately if turned on while door is open"
    mode: single
    trigger:
      - platform: state
        entity_id: climate.aire_andres
        from: "off"
    condition:
      - condition: state
        entity_id: binary_sensor.puerta_andres_contact
        state: "on"
    action:
      - delay:
          seconds: 2
      - action: climate.turn_off
        target:
          entity_id: climate.aire_andres

  # ===========================================================================
  # TV AUTOMATIONS
  # ===========================================================================

  # Turn TV OFF when room empty for X minutes
  - id: cuarto_andres_tv_off_empty
    alias: "Cuarto Andres - TV Off (Empty)"
    description: "Turn off TV when room has been empty for configured delay"
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.cuarto_andres_occupied
        to: "off"
        for:
          minutes: "{{ states('input_number.cuarto_andres_tv_off_delay') | int(10) }}"
    condition:
      - condition: state
        entity_id: input_boolean.cuarto_andres_tv_automation_enabled
        state: "on"
      - condition: template
        value_template: "{{ states('input_text.cuarto_andres_tv_entity') != 'none' }}"
    action:
      - action: media_player.turn_off
        target:
          entity_id: "{{ states('input_text.cuarto_andres_tv_entity') }}"

  # ===========================================================================
  # AC MANUAL OFF TRACKING
  # ===========================================================================

  # Track when AC is manually turned off between 08:00-12:00
  - id: cuarto_andres_ac_track_manual_off
    alias: "Cuarto Andres - Track AC Manual Off"
    description: "Set manual_off flag when AC turned off between 08:00-12:00"
    mode: single
    trigger:
      - platform: state
        entity_id: climate.aire_andres
        to: "off"
    condition:
      # Only track during 08:00-12:00
      - condition: template
        value_template: >
          {% set now_time = now().strftime('%H:%M:%S') %}
          {{ '08:00:00' <= now_time < '12:00:00' }}
    action:
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.cuarto_andres_ac_manual_off

  # Reset manual_off and door_off flags at midnight
  - id: cuarto_andres_ac_reset_flags
    alias: "Cuarto Andres - Reset AC Flags"
    description: "Reset manual_off and door_off flags at midnight"
    mode: single
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - action: input_boolean.turn_off
        target:
          entity_id:
            - input_boolean.cuarto_andres_ac_manual_off
            - input_boolean.cuarto_andres_ac_door_off